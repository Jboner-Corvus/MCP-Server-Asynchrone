# nginx/default.conf (Version Finale Définitive)
server {
    listen 8080;
    server_name localhost;

    # Force Nginx à utiliser le serveur DNS interne de Docker.
    resolver 127.0.0.11 valid=30s;

    location /mcp {
        # Gère les requêtes "preflight" OPTIONS du navigateur pour le CORS.
        if ($request_method = 'OPTIONS') {
            add_header 'Access-Control-Allow-Origin' '*' always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS' always;
            add_header 'Access-Control-Allow-Headers' 'Authorization, X-Session-ID, Content-Type, Range, DNT, User-Agent, X-Requested-With, If-Modified-Since, Cache-Control' always;
            add_header 'Access-Control-Max-Age' 86400;
            return 204;
        }

        # Transférer la requête au service 'fastmcp-server' sur son port 8080.
        # Utiliser une variable force l'utilisation du 'resolver'.
        set $upstream_server http://fastmcp-server:8080;
        proxy_pass $upstream_server;

        # En-têtes et options pour le streaming et la communication proxy.
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
        proxy_set_header Host $host;
        proxy_buffering off;
        proxy_cache off;
    }
}